version: 2

jobs: 
  build_and_test: 
    - run: 
        command: "escape build && escape test"
        name: "Build and test Escape release"
  release: 
    - run: 
        command: "escape release"
        name: "Build Escape release"
  setup: 
    docker: 
      - image: "ankyra/escape:latest"
    steps: 
      - checkout
      - setup_remote_docker
      - run: 
          command: |
              set -x
              VER="17.03.0-ce"
              curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
              tar -xz -C /tmp -f /tmp/docker-$VER.tgz
              mv /tmp/docker/* /usr/bin
          name: "Install Docker client"

workflows: 
  build_and_test: 
    jobs: 
      - build_and_test: 
          filters: 
            branches: 
              ignore: master
          requires: 
            - setup
  release: 
    jobs: 
      - release: 
          filters: 
            branches: 
              only: master
          requires: 
            - setup
  version: 2

